{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Gerador de QRCode | Festão AgRoss</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
</head>

<body class="custom-body">

    <!-- Botão de voltar -->
    <a href="{% url 'index' %}" class="btn btn-light position-absolute top-0 start-0 m-4">
        <i class="bi bi-arrow-bar-left"></i> Voltar
    </a>

    <div class="custom-card card shadow-sm p-4 w-100">
        <div class="card-body">
            <h1 class="card-title fs-4 mb-4 text-center">
                <i class="bi bi-barcode me-2"></i> Gerador de QRCode
            </h1>

            <!-- Instruções para o usuário -->
            <p class="text-light text-center mb-4">
                Utilize esta tela para gerar QR Codes para os convidados da sua empresa.
            </p>



            <!-- Resultados dos convidados encontrados -->
            {% if convidados %}
            <hr>
            <h5 class="text-light mt-4 text-center">Convidados encontrados:</h5>

            <div class="mt-4 row row-cols-1 row-cols-md-2 g-4 justify-content-center">
                {% for convidado in convidados %}
                <div class="col text-center">
                    <div class="qrcode-card card p-3">
                        <strong>{{ convidado.nome }}</strong>
                        <div id="qrcode-{{ forloop.counter }}" class="mt-2"></div>
                        <button class="btn btn-outline-success mt-2"
                            onclick="baixarQRCode('qrcode-{{ forloop.counter }}', '{{ convidado.cpf }}')">
                            <i class="bi bi-download"></i> Baixar QR Code
                        </button>
                        <script>
                            new QRCode(document.getElementById("qrcode-{{ forloop.counter }}"), {
                                text: "https://qrcode-festao-1.onrender.com/validar/?codigo={{ convidado.cpf }}",
                                width: 160,
                                height: 160,
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        </script>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% elif cnpj_consultado %}
            <div class="alert alert-warning mt-4 text-center">
                Nenhum convidado encontrado para o CNPJ <strong>{{ cnpj_consultado }}</strong>.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Script para baixar QR Code estilizado com nome -->
    <script>
        function baixarQRCode(containerId, nomeArquivo) {
            const cpf = nomeArquivo;
            const nomePessoa = document.querySelector(`#${containerId}`).previousElementSibling.textContent.trim();

            const qrStyled = new QRCodeStyling({
                width: 400,
                height: 400,
                data: `https://qrcode-festao-1.onrender.com/validar/?codigo=${cpf}`,
                image: "{% static 'imgs/logo-agross.png' %}", // logo opcional
                dotsOptions: {
                    color: "#000000",  // Mantém a cor preta dos pontos
                    type: "square"
                },
                backgroundOptions: {
                    color: "#ffffff"  // Mantém o fundo branco
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 10
                }
            });

            qrStyled.getRawData("png").then((blob) => {
                const img = new Image();
                img.src = URL.createObjectURL(blob);

                img.onload = function () {
                    const padding = 40;
                    const nomeAltura = 80;
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    canvas.width = img.width + padding * 2;
                    canvas.height = img.height + nomeAltura + padding * 2;

                    // Adicionando gradiente suave ao fundo
                    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, "#ffffff");
                    gradient.addColorStop(1, "#f0f0f0"); // Gradiente suave

                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // QR Code centralizado
                    ctx.shadowColor = "rgba(0, 0, 0, 0.2)";
                    ctx.shadowBlur = 6;
                    ctx.drawImage(img, padding, padding);

                    // Linha separadora
                    ctx.strokeStyle = "#cccccc";
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(padding, img.height + padding + 10);
                    ctx.lineTo(canvas.width - padding, img.height + padding + 10);
                    ctx.stroke();

                    // Nome estilizado
                    ctx.fillStyle = "#000000";
                    ctx.font = "bold 22px 'Segoe UI', sans-serif";
                    ctx.textAlign = "center";
                    ctx.shadowColor = "rgba(0, 0, 0, 0.2)";
                    ctx.shadowBlur = 2;
                    ctx.fillText(
                        nomePessoa.toUpperCase(),
                        canvas.width / 2,
                        canvas.height - padding + 10
                    );

                    // Adicionando bordas arredondadas ao QR Code
                    const radius = 20; // Definindo o raio das bordas
                    ctx.lineJoin = "round";
                    ctx.lineWidth = 5;
                    ctx.strokeStyle = "#000000"; // Cor da borda
                    ctx.strokeRect(padding - 10, padding - 10, img.width + 20, img.height + 20); // Borda arredondada

                    // Baixar imagem final
                    const a = document.createElement("a");
                    a.href = canvas.toDataURL("image/png");
                    a.download = `qrcode_${cpf}.png`;
                    a.click();
                };
            });
        }
    </script>

</body>

</html>