{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Check-in | Festão AgRoss</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="custom-body">
    <div class="custom-card card shadow-sm p-4 w-100">
        <div class="card-body">
            <h1 class="card-title fs-4 mb-4 text-center">
                Check-in | Festão AgRoss
            </h1>

            <!-- Validação manual -->
            <div class="mb-3 position-relative">
                <label for="manual-validation" class="icon-label">
                    <i class="bi bi-file-earmark-text"></i> Validação Manual
                </label>
                <div class="input-group">
                    <a href="{% url 'validador' %}" class="btn btn-success w-100">
                        <i class="bi bi-key"></i> Validar Convidado
                    </a>
                </div>
                <small class="form-text text-muted">
                    Clique para inserir manualmente as informações do convidado.
                </small>
            </div>

            <!-- Validação QR Code -->
            <div class="mb-3 position-relative">
                <label for="qr-validation" class="icon-label">
                    <i class="bi bi-camera"></i> Validação QR Code
                </label>
                <div class="input-group">
                    <button id="btn-abrir-camera" class="btn btn-success w-100">
                        <i class="bi bi-camera"></i> Escanear QR Code
                    </button>
                </div>
                <small class="form-text text-muted">
                    Use a câmera para escanear o QR Code do convidado.
                </small>
            </div>

            <!-- Leitor de QR Code -->
            <div id="reader-container" class="qr-container mt-4" style="display: none;">

                <div id="reader" class="qr-reader"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        const btnAbrirCamera = document.getElementById("btn-abrir-camera");
        const readerContainer = document.getElementById("reader-container");
        let html5QrCode;

        btnAbrirCamera.addEventListener("click", () => {
            readerContainer.style.display = "block";
            btnAbrirCamera.disabled = true;

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            html5QrCode.start(
                { facingMode: "environment" }, // Força uso da câmera traseira
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    html5QrCode.stop().then(() => {
                        let codigoExtraido;
                        try {
                            const url = new URL(decodedText);
                            const codigoParam = url.searchParams.get("codigo");
                            codigoExtraido = codigoParam ? codigoParam : decodedText;
                        } catch (e) {
                            codigoExtraido = decodedText;
                        }
                        window.location.href = `/validar/?codigo=${codigoExtraido}`;
                    }).catch(err => {
                        console.error("Erro ao parar o scanner: ", err);
                    });
                },
                (errorMessage) => {
                    // Erros de leitura
                }
            ).catch(err => {
                console.error("Erro ao iniciar scanner: ", err);
            });
        });
    </script>
</body>

</html>